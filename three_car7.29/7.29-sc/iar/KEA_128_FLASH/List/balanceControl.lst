###############################################################################
#
# IAR ANSI C/C++ Compiler V7.20.2.7424/W32 for ARM        12/Mar/2018  19:34:05
# Copyright 1999-2014 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  
#        C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\user\C\balanceControl.c
#    Command line =  
#        "C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\user\C\balanceControl.c" -D IAR -D TWR_K60N512 -D
#        _DLIB_FILE_DESCRIPTOR -lCN "C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\iar\KEA_128_FLASH\List\" -lB
#        "C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\iar\KEA_128_FLASH\List\" -o
#        "C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\iar\KEA_128_FLASH\Obj\"
#        --no_cse --no_unroll --no_inline --no_code_motion --no_tbaa
#        --no_clustering --no_scheduling --debug --endian=little
#        --cpu=Cortex-M0+ -e --fpu=None --dlib_config "C:\Program Files
#        (x86)\IAR Systems\Embedded Workbench
#        7.0\arm\INC\c\DLib_Config_Normal.h" -I
#        "C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\iar\..\device\H\" -I
#        "C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\iar\..\user\H\" -I
#        "C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\iar\..\system\" -I
#        "C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\iar\..\lib\H\" -I
#        "C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\iar\..\system\coreSupport\" -Ol
#    List file    =  
#        C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\iar\KEA_128_FLASH\List\balanceControl.lst
#    Object file  =  
#        C:\Users\陈帅印\Desktop\2018直立 -
#        KEA直立312\iar\KEA_128_FLASH\Obj\balanceControl.o
#
###############################################################################

C:\Users\陈帅印\Desktop\2018直立 - KEA直立312\user\C\balanceControl.c
      1          /**
      2            ******************************************************************************
      3            * COPYRIGHT NOTICE
      4            * Copyright (c) 2018,华北科技学院
      5            * All rights reserved.
      6            *
      7            * 文件名称：    balanceControl.c
      8            * 文件标识：
      9            * 摘    要：    平衡控制
     10            *
     11            * 当前版本：     1.0
     12            * 负    责：     韩志伟
     13            * 时    间：     2018年1月30日 20:35:50
     14            ******************************************************************************
     15            */
     16          
     17          #include "balanceControl.h"
     18          #include "Variable.h"
     19          #define PI 3.141592654
     20          #define INTEGRAL_TIME_CONSTANT 0.005         //积分时间
     21          

   \                                 In section .data, align 4
     22          float R_angle =  0.00009;//0.009;	//越小,收敛快速,但稳态值毛刺多;越大，收敛变慢，稳态值越平滑  往小调 主要决定收敛快慢，增大去噪点，跟随不及时
   \                     R_angle:
   \   00000000   0x38BCBE62         DC32 38BCBE62H

   \                                 In section .data, align 4
     23          float Q_angle = 0.0001;//0.00001;	//越大，收敛快速，但动态振幅过大，越小越好，大跟随性好噪点多
   \                     Q_angle:
   \   00000000   0x38D1B717         DC32 38D1B717H

   \                                 In section .data, align 4
     24          float Q_gyro = 0.0003;//0.00003;	//越小,滤出来的稳定角度不在加速度计的中心，往小调，不能太小，增大噪点多，跟随不及时
   \                     Q_gyro:
   \   00000000   0x399D4952         DC32 399D4952H
     25          
     26          //----------------------------陀螺仪--------------------------------------------

   \                                 In section .bss, align 4
     27          float gyr_angle_speed, gyr_angle = 0, gyr_offset_x = 35;//陀螺仪x,y轴偏移量
   \                     gyr_angle_speed:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     gyr_angle:
   \   00000000                      DS8 4

   \                                 In section .data, align 4
   \                     gyr_offset_x:
   \   00000000   0x420C0000         DC32 420C0000H
     28          //int16 gyr_offset_x;
     29          
     30          
     31          //----------------------------加速度计------------------------------------------

   \                                 In section .bss, align 4
     32          float acc_ave,acc_angle,acc_mid = 1211.76;//车体垂直地面的AD值
   \                     acc_ave:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     acc_angle:
   \   00000000                      DS8 4

   \                                 In section .data, align 4
   \                     acc_mid:
   \   00000000   0x44977852         DC32 44977852H

   \                                 In section .bss, align 4
     33          float acc_angle_cos;						//用于计算加速度计角度
   \                     acc_angle_cos:
   \   00000000                      DS8 4
     34          #define ACC_MV_NUM  1.220703125         //mv/num
     35          #define acc_ratio	0.00100708       		//加速度计比例系数（理论值）
     36          
     37          //---------------------------------直立控制-------------------------------------
     38          //angle_mid  103.3 无配重  92.4 加配重到最后
     39          //P_angle    1000起步调试

   \                                 In section .bss, align 4
     40          float car_angle = 0, car_angle_speed = 0;
   \                     car_angle:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     car_angle_speed:
   \   00000000                      DS8 4

   \                                 In section .data, align 4
     41          float angle_mid = 90.35;//83.5; //80.690;// 90.930	88.5 重心前倾会使速度不稳（82~125）
   \                     angle_mid:
   \   00000000   0x42B4B333         DC32 42B4B333H

   \                                 In section .data, align 4
     42          float low_spd_agl = 90;
   \                     low_spd_agl:
   \   00000000   0x42B40000         DC32 42B40000H

   \                                 In section .data, align 4
     43          float P_angle = 2100;//1900;//;3340;//5300;//9500; 5000 - 直立,太大车轮打滑车会发抖
   \                     P_angle:
   \   00000000   0x45034000         DC32 45034000H

   \                                 In section .bss, align 4
     44          float D_angle = 0;//6.3; //6.8; //6.300
   \                     D_angle:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
     45          float Angle_Out = 0;
   \                     Angle_Out:
   \   00000000                      DS8 4
     46          
     47          /**
     48            * 简介
     49            *     卡尔曼滤波
     50            * 注意
     51            *     1
     52            *       卡尔曼方程 见 助赢电子直立调试手册 PDF
     53            *     2
     54            *       陀螺仪短时间数据可信
     55            *       加速度计长时间数据可信，两者互补
     56            */

   \                                 In section .text, align 2, keep-with-next
     57          void Angle_Kalman(void)
     58          {
   \                     Angle_Kalman: (+1)
   \   00000000   0xB538             PUSH     {R3-R5,LR}
     59              static float Pdot[4] = {0,0,0,0};             //过程协方差矩阵的微分矩阵
     60              static float P[2][2] = {{ 1, 0 }, { 0, 1 }};  //过程协方差矩阵      |1  0|
     61              static float gyro_error = 0, angle_error = 0; //陀螺仪角速度的偏差（数值由卡尔曼方程计算更新）  |0  1|
     62              static float K_0 = 0, K_1 = 0;                //含有卡尔曼增益的另外一个函数，用于计算最优估计值
     63              static float E, t_0, t_1;
     64          
     65              //陀螺仪测车角度
     66              L3G4200_Read();
   \   00000002   0x.... 0x....      BL       L3G4200_Read
     67              gyr_angle_speed = ((float)gyro_x-gyr_offset_x)*gyr_ratio; //X,角速度，度/秒
   \   00000006   0x....             LDR      R0,??DataTable0_14
   \   00000008   0x2100             MOVS     R1,#+0
   \   0000000A   0x5E40             LDRSH    R0,[R0, R1]
   \   0000000C   0x.... 0x....      BL       __aeabi_i2f
   \   00000010   0x....             LDR      R1,??DataTable0_15
   \   00000012   0x6809             LDR      R1,[R1, #+0]
   \   00000014   0x.... 0x....      BL       __aeabi_fsub
   \   00000018   0x.... 0x....      BL       __aeabi_f2d
   \   0000001C   0x....             ADR      R2,??DataTable0_16
   \   0000001E   0xCA0C             LDM      R2,{R2,R3}
   \   00000020   0x.... 0x....      BL       __aeabi_dmul
   \   00000024   0x.... 0x....      BL       __aeabi_d2f
   \   00000028   0x....             LDR      R1,??DataTable0_13
   \   0000002A   0x6008             STR      R0,[R1, #+0]
     68          
     69              //加速度计测车角度
     70              acc_ave = hw_ad_ave(MMA7361, adc12bit, 10);//jlink是3.3v供电，而电池是5v，所以基准电压不同，采集参数会不一样
   \   0000002C   0x220A             MOVS     R2,#+10
   \   0000002E   0x2102             MOVS     R1,#+2
   \   00000030   0x2009             MOVS     R0,#+9
   \   00000032   0x.... 0x....      BL       hw_ad_ave
   \   00000036   0x.... 0x....      BL       __aeabi_ui2f
   \   0000003A   0x....             LDR      R1,??DataTable0_18
   \   0000003C   0x6008             STR      R0,[R1, #+0]
     71          //    acc_angle_cos = (acc_mid - acc_ave)*acc_ratio;/* 推算不出来这个算式 --- han */
     72              acc_angle_cos = (float)(((acc_ave + 1351.68 - acc_mid)*ACC_MV_NUM - 1650) / 7840.0);
   \   0000003E   0x....             LDR      R0,??DataTable0_18
   \   00000040   0x6800             LDR      R0,[R0, #+0]
   \   00000042   0x.... 0x....      BL       __aeabi_f2d
   \   00000046   0x....             ADR      R2,??DataTable0_17
   \   00000048   0xCA0C             LDM      R2,{R2,R3}
   \   0000004A   0x.... 0x....      BL       __aeabi_dadd
   \   0000004E   0x0004             MOVS     R4,R0
   \   00000050   0x000D             MOVS     R5,R1
   \   00000052   0x....             LDR      R0,??DataTable0_5
   \   00000054   0x6800             LDR      R0,[R0, #+0]
   \   00000056   0x.... 0x....      BL       __aeabi_f2d
   \   0000005A   0x0002             MOVS     R2,R0
   \   0000005C   0x000B             MOVS     R3,R1
   \   0000005E   0x0020             MOVS     R0,R4
   \   00000060   0x0029             MOVS     R1,R5
   \   00000062   0x.... 0x....      BL       __aeabi_dsub
   \   00000066   0x2200             MOVS     R2,#+0
   \   00000068   0x....             LDR      R3,??DataTable0  ;; 0x3ff38800
   \   0000006A   0x.... 0x....      BL       __aeabi_dmul
   \   0000006E   0x2200             MOVS     R2,#+0
   \   00000070   0x....             LDR      R3,??DataTable0_1  ;; 0xc099c800
   \   00000072   0x.... 0x....      BL       __aeabi_dadd
   \   00000076   0x2200             MOVS     R2,#+0
   \   00000078   0x....             LDR      R3,??DataTable0_2  ;; 0x40bea000
   \   0000007A   0x.... 0x....      BL       __aeabi_ddiv
   \   0000007E   0x.... 0x....      BL       __aeabi_d2f
   \   00000082   0x....             LDR      R1,??DataTable0_4
   \   00000084   0x6008             STR      R0,[R1, #+0]
     73          
     74              if (acc_angle_cos > 1.0)
   \   00000086   0x....             LDR      R0,??DataTable0_4
   \   00000088   0x6800             LDR      R0,[R0, #+0]
   \   0000008A   0x....             LDR      R1,??DataTable0_3  ;; 0x3f800001
   \   0000008C   0x.... 0x....      BL       __aeabi_cfrcmple
   \   00000090   0xD804             BHI      ??Angle_Kalman_0
     75                  acc_angle_cos  = 1.0;
   \   00000092   0x20FE             MOVS     R0,#+254
   \   00000094   0x0580             LSLS     R0,R0,#+22       ;; #+1065353216
   \   00000096   0x....             LDR      R1,??DataTable0_4
   \   00000098   0x6008             STR      R0,[R1, #+0]
   \   0000009A   0xE008             B        ??Angle_Kalman_1
     76              else if (acc_angle_cos < -1.0)
   \                     ??Angle_Kalman_0: (+1)
   \   0000009C   0x....             LDR      R0,??DataTable0_4
   \   0000009E   0x6800             LDR      R0,[R0, #+0]
   \   000000A0   0x....             LDR      R1,??DataTable0_6  ;; 0xbf800000
   \   000000A2   0x.... 0x....      BL       __aeabi_cfcmple
   \   000000A6   0xD202             BCS      ??Angle_Kalman_1
     77                  acc_angle_cos  = -1.0;
   \   000000A8   0x....             LDR      R0,??DataTable0_6  ;; 0xbf800000
   \   000000AA   0x....             LDR      R1,??DataTable0_4
   \   000000AC   0x6008             STR      R0,[R1, #+0]
     78          
     79              acc_angle = acos(acc_angle_cos)*180/PI;     //转换为角度
   \                     ??Angle_Kalman_1: (+1)
   \   000000AE   0x....             LDR      R0,??DataTable0_4
   \   000000B0   0x6800             LDR      R0,[R0, #+0]
   \   000000B2   0x.... 0x....      BL       __aeabi_f2d
   \   000000B6   0x.... 0x....      BL       acos
   \   000000BA   0x2200             MOVS     R2,#+0
   \   000000BC   0x....             LDR      R3,??DataTable0_7  ;; 0x40668000
   \   000000BE   0x.... 0x....      BL       __aeabi_dmul
   \   000000C2   0x....             ADR      R2,??DataTable0_8
   \   000000C4   0xCA0C             LDM      R2,{R2,R3}
   \   000000C6   0x.... 0x....      BL       __aeabi_ddiv
   \   000000CA   0x.... 0x....      BL       __aeabi_d2f
   \   000000CE   0x....             LDR      R1,??DataTable0_11
   \   000000D0   0x6008             STR      R0,[R1, #+0]
     80          
     81              /* 1 先验估计 -----------------------------------------------------------  */
     82              //根据上一次车体角度估计本次角度
     83              //现在的角度 = 上次的角度 + (陀螺仪所测角速度 - 静态偏移)*陀螺仪采样周期
     84              car_angle += (gyr_angle_speed-gyro_error) * INTEGRAL_TIME_CONSTANT;
   \   000000D2   0x....             LDR      R0,??DataTable0_12
   \   000000D4   0x6800             LDR      R0,[R0, #+0]
   \   000000D6   0x.... 0x....      BL       __aeabi_f2d
   \   000000DA   0x0004             MOVS     R4,R0
   \   000000DC   0x000D             MOVS     R5,R1
   \   000000DE   0x....             LDR      R0,??DataTable0_13
   \   000000E0   0x6800             LDR      R0,[R0, #+0]
   \   000000E2   0x....             LDR      R1,??DataTable1_10
   \   000000E4   0x6809             LDR      R1,[R1, #+0]
   \   000000E6   0x.... 0x....      BL       __aeabi_fsub
   \   000000EA   0x.... 0x....      BL       __aeabi_f2d
   \   000000EE   0x....             ADR      R2,??DataTable0_10
   \   000000F0   0xCA0C             LDM      R2,{R2,R3}
   \   000000F2   0x.... 0x....      BL       __aeabi_dmul
   \   000000F6   0x0022             MOVS     R2,R4
   \   000000F8   0x002B             MOVS     R3,R5
   \   000000FA   0x.... 0x....      BL       __aeabi_dadd
   \   000000FE   0x.... 0x....      BL       __aeabi_d2f
   \   00000102   0x....             LDR      R1,??DataTable0_12
   \   00000104   0x6008             STR      R0,[R1, #+0]
     85          
     86              /* 2 预测方差阵的预测值 -------------------------------------------------- */
     87              //计算过程协方差矩阵的微分矩阵
     88              Pdot[0] = Q_angle  - P[0][1] - P[1][0];
   \   00000106   0x....             LDR      R0,??DataTable0_9
   \   00000108   0x6800             LDR      R0,[R0, #+0]
   \   0000010A   0x....             LDR      R1,??DataTable1_6
   \   0000010C   0x6849             LDR      R1,[R1, #+4]
   \   0000010E   0x.... 0x....      BL       __aeabi_fsub
   \   00000112   0x....             LDR      R1,??DataTable1_6
   \   00000114   0x6889             LDR      R1,[R1, #+8]
   \   00000116   0x.... 0x....      BL       __aeabi_fsub
   \   0000011A   0x....             LDR      R1,??DataTable1_1
   \   0000011C   0x6008             STR      R0,[R1, #+0]
     89              Pdot[1] = - P[1][1];
   \   0000011E   0x....             LDR      R0,??DataTable1_6
   \   00000120   0x68C0             LDR      R0,[R0, #+12]
   \   00000122   0x2180             MOVS     R1,#+128
   \   00000124   0x0609             LSLS     R1,R1,#+24       ;; #-2147483648
   \   00000126   0x4048             EORS     R0,R0,R1
   \   00000128   0x....             LDR      R1,??DataTable1_1
   \   0000012A   0x6048             STR      R0,[R1, #+4]
     90              Pdot[2] = - P[1][1];
   \   0000012C   0x....             LDR      R0,??DataTable1_6
   \   0000012E   0x68C0             LDR      R0,[R0, #+12]
   \   00000130   0x2180             MOVS     R1,#+128
   \   00000132   0x0609             LSLS     R1,R1,#+24       ;; #-2147483648
   \   00000134   0x4048             EORS     R0,R0,R1
   \   00000136   0x....             LDR      R1,??DataTable1_1
   \   00000138   0x6088             STR      R0,[R1, #+8]
     91              Pdot[3] = Q_gyro;
   \   0000013A   0x....             LDR      R0,??DataTable1
   \   0000013C   0x6800             LDR      R0,[R0, #+0]
   \   0000013E   0x....             LDR      R1,??DataTable1_1
   \   00000140   0x60C8             STR      R0,[R1, #+12]
     92          
     93              //计算协方差矩阵
     94              P[0][0] += Pdot[0] * INTEGRAL_TIME_CONSTANT;
   \   00000142   0x....             LDR      R0,??DataTable1_6
   \   00000144   0x6800             LDR      R0,[R0, #+0]
   \   00000146   0x.... 0x....      BL       __aeabi_f2d
   \   0000014A   0x0004             MOVS     R4,R0
   \   0000014C   0x000D             MOVS     R5,R1
   \   0000014E   0x....             LDR      R0,??DataTable1_1
   \   00000150   0x6800             LDR      R0,[R0, #+0]
   \   00000152   0x.... 0x....      BL       __aeabi_f2d
   \   00000156   0x....             ADR      R2,??DataTable0_10
   \   00000158   0xCA0C             LDM      R2,{R2,R3}
   \   0000015A   0x.... 0x....      BL       __aeabi_dmul
   \   0000015E   0x0022             MOVS     R2,R4
   \   00000160   0x002B             MOVS     R3,R5
   \   00000162   0x.... 0x....      BL       __aeabi_dadd
   \   00000166   0x.... 0x....      BL       __aeabi_d2f
   \   0000016A   0x....             LDR      R1,??DataTable1_6
   \   0000016C   0x6008             STR      R0,[R1, #+0]
     95              P[0][1] += Pdot[1] * INTEGRAL_TIME_CONSTANT;
   \   0000016E   0x....             LDR      R0,??DataTable1_6
   \   00000170   0x6840             LDR      R0,[R0, #+4]
   \   00000172   0x.... 0x....      BL       __aeabi_f2d
   \   00000176   0x0004             MOVS     R4,R0
   \   00000178   0x000D             MOVS     R5,R1
   \   0000017A   0x....             LDR      R0,??DataTable1_1
   \   0000017C   0x6840             LDR      R0,[R0, #+4]
   \   0000017E   0x.... 0x....      BL       __aeabi_f2d
   \   00000182   0x....             ADR      R2,??DataTable0_10
   \   00000184   0xCA0C             LDM      R2,{R2,R3}
   \   00000186   0x.... 0x....      BL       __aeabi_dmul
   \   0000018A   0x0022             MOVS     R2,R4
   \   0000018C   0x002B             MOVS     R3,R5
   \   0000018E   0x.... 0x....      BL       __aeabi_dadd
   \   00000192   0x.... 0x....      BL       __aeabi_d2f
   \   00000196   0x....             LDR      R1,??DataTable1_6
   \   00000198   0x6048             STR      R0,[R1, #+4]
     96              P[1][0] += Pdot[2] * INTEGRAL_TIME_CONSTANT;
   \   0000019A   0x....             LDR      R0,??DataTable1_6
   \   0000019C   0x6880             LDR      R0,[R0, #+8]
   \   0000019E   0x.... 0x....      BL       __aeabi_f2d
   \   000001A2   0x0004             MOVS     R4,R0
   \   000001A4   0x000D             MOVS     R5,R1
   \   000001A6   0x....             LDR      R0,??DataTable1_1
   \   000001A8   0x6880             LDR      R0,[R0, #+8]
   \   000001AA   0x.... 0x....      BL       __aeabi_f2d
   \   000001AE   0x....             ADR      R2,??DataTable0_10
   \   000001B0   0xCA0C             LDM      R2,{R2,R3}
   \   000001B2   0x.... 0x....      BL       __aeabi_dmul
   \   000001B6   0x0022             MOVS     R2,R4
   \   000001B8   0x002B             MOVS     R3,R5
   \   000001BA   0x.... 0x....      BL       __aeabi_dadd
   \   000001BE   0x.... 0x....      BL       __aeabi_d2f
   \   000001C2   0x....             LDR      R1,??DataTable1_6
   \   000001C4   0x6088             STR      R0,[R1, #+8]
     97              P[1][1] += Pdot[3] * INTEGRAL_TIME_CONSTANT;
   \   000001C6   0x....             LDR      R0,??DataTable1_6
   \   000001C8   0x68C0             LDR      R0,[R0, #+12]
   \   000001CA   0x.... 0x....      BL       __aeabi_f2d
   \   000001CE   0x0004             MOVS     R4,R0
   \   000001D0   0x000D             MOVS     R5,R1
   \   000001D2   0x....             LDR      R0,??DataTable1_1
   \   000001D4   0x68C0             LDR      R0,[R0, #+12]
   \   000001D6   0x.... 0x....      BL       __aeabi_f2d
   \   000001DA   0x....             ADR      R2,??DataTable0_10
   \   000001DC   0xCA0C             LDM      R2,{R2,R3}
   \   000001DE   0x.... 0x....      BL       __aeabi_dmul
   \   000001E2   0x0022             MOVS     R2,R4
   \   000001E4   0x002B             MOVS     R3,R5
   \   000001E6   0x.... 0x....      BL       __aeabi_dadd
   \   000001EA   0x.... 0x....      BL       __aeabi_d2f
   \   000001EE   0x....             LDR      R1,??DataTable1_6
   \   000001F0   0x60C8             STR      R0,[R1, #+12]
     98          
     99              /* 3 计算卡尔曼增益 ------------------------------------------------------ */
    100              E = R_angle + P[0][0];
   \   000001F2   0x....             LDR      R0,??DataTable1_2
   \   000001F4   0x6801             LDR      R1,[R0, #+0]
   \   000001F6   0x....             LDR      R0,??DataTable1_6
   \   000001F8   0x6800             LDR      R0,[R0, #+0]
   \   000001FA   0x.... 0x....      BL       __aeabi_fadd
   \   000001FE   0x....             LDR      R1,??DataTable1_3
   \   00000200   0x6008             STR      R0,[R1, #+0]
    101              //计算卡尔曼增益
    102              K_0 =  P[0][0] / E;
   \   00000202   0x....             LDR      R0,??DataTable1_6
   \   00000204   0x6800             LDR      R0,[R0, #+0]
   \   00000206   0x....             LDR      R1,??DataTable1_3
   \   00000208   0x6809             LDR      R1,[R1, #+0]
   \   0000020A   0x.... 0x....      BL       __aeabi_fdiv
   \   0000020E   0x....             LDR      R1,??DataTable1_7
   \   00000210   0x6008             STR      R0,[R1, #+0]
    103              K_1 =  P[1][0] / E;
   \   00000212   0x....             LDR      R0,??DataTable1_6
   \   00000214   0x6880             LDR      R0,[R0, #+8]
   \   00000216   0x....             LDR      R1,??DataTable1_3
   \   00000218   0x6809             LDR      R1,[R1, #+0]
   \   0000021A   0x.... 0x....      BL       __aeabi_fdiv
   \   0000021E   0x....             LDR      R1,??DataTable1_8
   \   00000220   0x6008             STR      R0,[R1, #+0]
    104          
    105              /* 5 更新协方差矩阵 ------------------------------------------------------ */
    106              t_0 = P[0][0];
   \   00000222   0x....             LDR      R0,??DataTable1_6
   \   00000224   0x6800             LDR      R0,[R0, #+0]
   \   00000226   0x....             LDR      R1,??DataTable1_4
   \   00000228   0x6008             STR      R0,[R1, #+0]
    107              t_1 = P[0][1];
   \   0000022A   0x....             LDR      R0,??DataTable1_6
   \   0000022C   0x6840             LDR      R0,[R0, #+4]
   \   0000022E   0x....             LDR      R1,??DataTable1_5
   \   00000230   0x6008             STR      R0,[R1, #+0]
    108          
    109              //更新协方差矩阵
    110              P[0][0] -= K_0 * t_0;  //P(K|K)
   \   00000232   0x....             LDR      R0,??DataTable1_7
   \   00000234   0x6801             LDR      R1,[R0, #+0]
   \   00000236   0x....             LDR      R0,??DataTable1_4
   \   00000238   0x6800             LDR      R0,[R0, #+0]
   \   0000023A   0x.... 0x....      BL       __aeabi_fmul
   \   0000023E   0x0001             MOVS     R1,R0
   \   00000240   0x....             LDR      R0,??DataTable1_6
   \   00000242   0x6800             LDR      R0,[R0, #+0]
   \   00000244   0x.... 0x....      BL       __aeabi_fsub
   \   00000248   0x....             LDR      R1,??DataTable1_6
   \   0000024A   0x6008             STR      R0,[R1, #+0]
    111              P[0][1] -= K_0 * t_1;
   \   0000024C   0x....             LDR      R0,??DataTable1_7
   \   0000024E   0x6801             LDR      R1,[R0, #+0]
   \   00000250   0x....             LDR      R0,??DataTable1_5
   \   00000252   0x6800             LDR      R0,[R0, #+0]
   \   00000254   0x.... 0x....      BL       __aeabi_fmul
   \   00000258   0x0001             MOVS     R1,R0
   \   0000025A   0x....             LDR      R0,??DataTable1_6
   \   0000025C   0x6840             LDR      R0,[R0, #+4]
   \   0000025E   0x.... 0x....      BL       __aeabi_fsub
   \   00000262   0x....             LDR      R1,??DataTable1_6
   \   00000264   0x6048             STR      R0,[R1, #+4]
    112              P[1][0] -= K_1 * t_0;
   \   00000266   0x....             LDR      R0,??DataTable1_8
   \   00000268   0x6801             LDR      R1,[R0, #+0]
   \   0000026A   0x....             LDR      R0,??DataTable1_4
   \   0000026C   0x6800             LDR      R0,[R0, #+0]
   \   0000026E   0x.... 0x....      BL       __aeabi_fmul
   \   00000272   0x0001             MOVS     R1,R0
   \   00000274   0x....             LDR      R0,??DataTable1_6
   \   00000276   0x6880             LDR      R0,[R0, #+8]
   \   00000278   0x.... 0x....      BL       __aeabi_fsub
   \   0000027C   0x....             LDR      R1,??DataTable1_6
   \   0000027E   0x6088             STR      R0,[R1, #+8]
    113              P[1][1] -= K_1 * t_1;
   \   00000280   0x....             LDR      R0,??DataTable1_8
   \   00000282   0x6801             LDR      R1,[R0, #+0]
   \   00000284   0x....             LDR      R0,??DataTable1_5
   \   00000286   0x6800             LDR      R0,[R0, #+0]
   \   00000288   0x.... 0x....      BL       __aeabi_fmul
   \   0000028C   0x0001             MOVS     R1,R0
   \   0000028E   0x....             LDR      R0,??DataTable1_6
   \   00000290   0x68C0             LDR      R0,[R0, #+12]
   \   00000292   0x.... 0x....      BL       __aeabi_fsub
   \   00000296   0x....             LDR      R1,??DataTable1_6
   \   00000298   0x60C8             STR      R0,[R1, #+12]
    114          
    115              /* 4 用误差还有卡尔曼增益来修正 ------------------------------------------- */
    116              angle_error = acc_angle - car_angle;
   \   0000029A   0x....             LDR      R0,??DataTable0_11
   \   0000029C   0x6800             LDR      R0,[R0, #+0]
   \   0000029E   0x....             LDR      R1,??DataTable0_12
   \   000002A0   0x6809             LDR      R1,[R1, #+0]
   \   000002A2   0x.... 0x....      BL       __aeabi_fsub
   \   000002A6   0x....             LDR      R1,??DataTable1_9
   \   000002A8   0x6008             STR      R0,[R1, #+0]
    117              //给出最优估计值
    118              car_angle += K_0 * angle_error; //X(K|K)
   \   000002AA   0x....             LDR      R0,??DataTable1_7
   \   000002AC   0x6801             LDR      R1,[R0, #+0]
   \   000002AE   0x....             LDR      R0,??DataTable1_9
   \   000002B0   0x6800             LDR      R0,[R0, #+0]
   \   000002B2   0x.... 0x....      BL       __aeabi_fmul
   \   000002B6   0x....             LDR      R1,??DataTable0_12
   \   000002B8   0x6809             LDR      R1,[R1, #+0]
   \   000002BA   0x.... 0x....      BL       __aeabi_fadd
   \   000002BE   0x....             LDR      R1,??DataTable0_12
   \   000002C0   0x6008             STR      R0,[R1, #+0]
    119              //更新最优估计值偏差
    120              gyro_error += K_1 * angle_error; //X(K|K)
   \   000002C2   0x....             LDR      R0,??DataTable1_8
   \   000002C4   0x6801             LDR      R1,[R0, #+0]
   \   000002C6   0x....             LDR      R0,??DataTable1_9
   \   000002C8   0x6800             LDR      R0,[R0, #+0]
   \   000002CA   0x.... 0x....      BL       __aeabi_fmul
   \   000002CE   0x....             LDR      R1,??DataTable1_10
   \   000002D0   0x6809             LDR      R1,[R1, #+0]
   \   000002D2   0x.... 0x....      BL       __aeabi_fadd
   \   000002D6   0x....             LDR      R1,??DataTable1_10
   \   000002D8   0x6008             STR      R0,[R1, #+0]
    121              //为了PID控制把角速度算出来
    122              car_angle_speed = gyr_angle_speed - gyro_error;
   \   000002DA   0x....             LDR      R0,??DataTable0_13
   \   000002DC   0x6800             LDR      R0,[R0, #+0]
   \   000002DE   0x....             LDR      R1,??DataTable1_10
   \   000002E0   0x6809             LDR      R1,[R1, #+0]
   \   000002E2   0x.... 0x....      BL       __aeabi_fsub
   \   000002E6   0x....             LDR      R1,??DataTable1_18
   \   000002E8   0x6008             STR      R0,[R1, #+0]
    123          }
   \   000002EA   0xBD31             POP      {R0,R4,R5,PC}    ;; return

   \                                 In section .bss, align 4
   \                     ??Pdot:
   \   00000000                      DS8 16

   \                                 In section .data, align 4
   \                     ??P:
   \   00000000   0x3F800000         DC32 3F800000H, 0H, 0H, 3F800000H
   \              0x00000000   
   \              0x00000000   
   \              0x3F800000   

   \                                 In section .bss, align 4
   \                     ??gyro_error:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??angle_error:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??K_0:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??K_1:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??E:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??t_0:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??t_1:
   \   00000000                      DS8 4
    124          
    125          /**
    126            * 简介
    127            *     直立控制
    128            * 注意
    129            *     math.h中三角函数用的是 弧度
    130            */

   \                                 In section .text, align 2, keep-with-next
    131          void Angle_Controler(void)
    132          {
   \                     Angle_Controler: (+1)
   \   00000000   0xB510             PUSH     {R4,LR}
    133              static float angle_E, E_angle;
    134          
    135              angle_E = (angle_mid - car_angle);
   \   00000002   0x....             LDR      R0,??DataTable1_11
   \   00000004   0x6800             LDR      R0,[R0, #+0]
   \   00000006   0x....             LDR      R1,??DataTable1_12
   \   00000008   0x6809             LDR      R1,[R1, #+0]
   \   0000000A   0x.... 0x....      BL       __aeabi_fsub
   \   0000000E   0x....             LDR      R1,??DataTable1_13
   \   00000010   0x6008             STR      R0,[R1, #+0]
    136          
    137              //>E_angle 才能直立起来(使用它实际上是因为P_angle的取值范围太小，所以只能使误差角范围变小)
    138              E_angle = tan(angle_E/180*PI) * 9.8;//a > tan(θ) * g -> 恢复力使小车恢复
   \   00000012   0x....             LDR      R0,??DataTable1_13
   \   00000014   0x6800             LDR      R0,[R0, #+0]
   \   00000016   0x....             LDR      R1,??DataTable1_14  ;; 0x43340000
   \   00000018   0x.... 0x....      BL       __aeabi_fdiv
   \   0000001C   0x.... 0x....      BL       __aeabi_f2d
   \   00000020   0x....             ADR      R2,??DataTable1_15
   \   00000022   0xCA0C             LDM      R2,{R2,R3}
   \   00000024   0x.... 0x....      BL       __aeabi_dmul
   \   00000028   0x.... 0x....      BL       tan
   \   0000002C   0x....             ADR      R2,??DataTable1_16
   \   0000002E   0xCA0C             LDM      R2,{R2,R3}
   \   00000030   0x.... 0x....      BL       __aeabi_dmul
   \   00000034   0x.... 0x....      BL       __aeabi_d2f
   \   00000038   0x....             LDR      R1,??DataTable1_20
   \   0000003A   0x6008             STR      R0,[R1, #+0]
    139              //tan(θ) -0.414~0.374
    140              //E_angle
    141          
    142              //    Angle_Out = -( P_angle*angle_E ) - D_angle*car_angle_speed;//取值范围太小，此方案不行
    143          
    144              Angle_Out = -(P_angle*E_angle) + D_angle*car_angle_speed;// E_angle = 10 <-> 0.02985259896577487006352080076417
   \   0000003C   0x....             LDR      R0,??DataTable1_17
   \   0000003E   0x6801             LDR      R1,[R0, #+0]
   \   00000040   0x....             LDR      R0,??DataTable1_18
   \   00000042   0x6800             LDR      R0,[R0, #+0]
   \   00000044   0x.... 0x....      BL       __aeabi_fmul
   \   00000048   0x0004             MOVS     R4,R0
   \   0000004A   0x....             LDR      R0,??DataTable1_19
   \   0000004C   0x6801             LDR      R1,[R0, #+0]
   \   0000004E   0x....             LDR      R0,??DataTable1_20
   \   00000050   0x6800             LDR      R0,[R0, #+0]
   \   00000052   0x.... 0x....      BL       __aeabi_fmul
   \   00000056   0x0001             MOVS     R1,R0
   \   00000058   0x0020             MOVS     R0,R4
   \   0000005A   0x.... 0x....      BL       __aeabi_fsub
   \   0000005E   0x....             LDR      R1,??DataTable1_21
   \   00000060   0x6008             STR      R0,[R1, #+0]
    145              // P_angle*E_angle 349.2858
    146              //gyr_angle_speed 32.4  D_angle*gyr_angle_speed 1.8 负！！
    147              //	DataScope_Get_Channel_Data(car_angle,3);
    148          
    149          
    150          //        UART_SendFloat(gyro_x, 1);
    151              switch (chice)
   \   00000062   0x....             LDR      R0,??DataTable1_22
   \   00000064   0x7800             LDRB     R0,[R0, #+0]
   \   00000066   0x2800             CMP      R0,#+0
   \   00000068   0xD003             BEQ      ??Angle_Controler_0
   \   0000006A   0x2802             CMP      R0,#+2
   \   0000006C   0xD010             BEQ      ??Angle_Controler_1
   \   0000006E   0xD305             BCC      ??Angle_Controler_2
   \   00000070   0xE01A             B        ??Angle_Controler_3
    152              {
    153                case 0:
    154                  LED_2_OFF;
   \                     ??Angle_Controler_0: (+1)
   \   00000072   0x2101             MOVS     R1,#+1
   \   00000074   0x2032             MOVS     R0,#+50
   \   00000076   0x.... 0x....      BL       GpioSet
    155                  break;
   \   0000007A   0xE015             B        ??Angle_Controler_4
    156          
    157                case 1:
    158                  LED_2_ON;
   \                     ??Angle_Controler_2: (+1)
   \   0000007C   0x2100             MOVS     R1,#+0
   \   0000007E   0x2032             MOVS     R0,#+50
   \   00000080   0x.... 0x....      BL       GpioSet
    159                  UART_SendFloat(acc_ave, 1);
   \   00000084   0x2101             MOVS     R1,#+1
   \   00000086   0x....             LDR      R0,??DataTable1_23
   \   00000088   0x6800             LDR      R0,[R0, #+0]
   \   0000008A   0x.... 0x....      BL       UART_SendFloat
    160                  break;
   \   0000008E   0xE00B             B        ??Angle_Controler_4
    161          
    162                case 2:
    163                  LED_2_ON;
   \                     ??Angle_Controler_1: (+1)
   \   00000090   0x2100             MOVS     R1,#+0
   \   00000092   0x2032             MOVS     R0,#+50
   \   00000094   0x.... 0x....      BL       GpioSet
    164                  OutPut_Data(acc_ave, 0, 0, 0);
   \   00000098   0x2300             MOVS     R3,#+0
   \   0000009A   0x2200             MOVS     R2,#+0
   \   0000009C   0x2100             MOVS     R1,#+0
   \   0000009E   0x....             LDR      R0,??DataTable1_23
   \   000000A0   0x6800             LDR      R0,[R0, #+0]
   \   000000A2   0x.... 0x....      BL       OutPut_Data
    165          //        UART_SendFloat(car_angle, 1);
    166                  break;
   \   000000A6   0xE7FF             B        ??Angle_Controler_4
    167          
    168                default :
    169                  break;
    170              }
    171          }
   \                     ??Angle_Controler_3: (+1)
   \                     ??Angle_Controler_4: (+1)
   \   000000A8   0xBD10             POP      {R4,PC}          ;; return

   \                                 In section .bss, align 4
   \                     ??angle_E:
   \   00000000                      DS8 4

   \                                 In section .bss, align 4
   \                     ??E_angle:
   \   00000000                      DS8 4

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0:
   \   00000000   0x3FF38800         DC32     0x3ff38800

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_1:
   \   00000000   0xC099C800         DC32     0xc099c800

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_2:
   \   00000000   0x40BEA000         DC32     0x40bea000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_3:
   \   00000000   0x3F800001         DC32     0x3f800001

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_4:
   \   00000000   0x........         DC32     acc_angle_cos

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_5:
   \   00000000   0x........         DC32     acc_mid

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_6:
   \   00000000   0xBF800000         DC32     0xbf800000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_7:
   \   00000000   0x40668000         DC32     0x40668000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_8:
   \   00000000   0x54524550         DC32     0x54524550,0x400921FB
   \              0x400921FB   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_9:
   \   00000000   0x........         DC32     Q_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_10:
   \   00000000   0x47AE147B         DC32     0x47AE147B,0x3F747AE1
   \              0x3F747AE1   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_11:
   \   00000000   0x........         DC32     acc_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_12:
   \   00000000   0x........         DC32     car_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_13:
   \   00000000   0x........         DC32     gyr_angle_speed

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_14:
   \   00000000   0x........         DC32     gyro_x

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_15:
   \   00000000   0x........         DC32     gyr_offset_x

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_16:
   \   00000000   0x1EB851EC         DC32     0x1EB851EC,0xBF81EB85
   \              0xBF81EB85   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_17:
   \   00000000   0x51EB851F         DC32     0x51EB851F,0x40951EB8
   \              0x40951EB8   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_18:
   \   00000000   0x........         DC32     acc_ave

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1:
   \   00000000   0x........         DC32     Q_gyro

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_1:
   \   00000000   0x........         DC32     ??Pdot

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_2:
   \   00000000   0x........         DC32     R_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_3:
   \   00000000   0x........         DC32     ??E

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_4:
   \   00000000   0x........         DC32     ??t_0

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_5:
   \   00000000   0x........         DC32     ??t_1

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_6:
   \   00000000   0x........         DC32     ??P

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_7:
   \   00000000   0x........         DC32     ??K_0

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_8:
   \   00000000   0x........         DC32     ??K_1

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_9:
   \   00000000   0x........         DC32     ??angle_error

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_10:
   \   00000000   0x........         DC32     ??gyro_error

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_11:
   \   00000000   0x........         DC32     angle_mid

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_12:
   \   00000000   0x........         DC32     car_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_13:
   \   00000000   0x........         DC32     ??angle_E

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_14:
   \   00000000   0x43340000         DC32     0x43340000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_15:
   \   00000000   0x54524550         DC32     0x54524550,0x400921FB
   \              0x400921FB   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_16:
   \   00000000   0x9999999A         DC32     0x9999999A,0x40239999
   \              0x40239999   

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_17:
   \   00000000   0x........         DC32     D_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_18:
   \   00000000   0x........         DC32     car_angle_speed

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_19:
   \   00000000   0x........         DC32     P_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_20:
   \   00000000   0x........         DC32     ??E_angle

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_21:
   \   00000000   0x........         DC32     Angle_Out

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_22:
   \   00000000   0x........         DC32     chice

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable1_23:
   \   00000000   0x........         DC32     acc_ave
    172          
    173          

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       8   Angle_Controler
         8   -> GpioSet
         8   -> OutPut_Data
         8   -> UART_SendFloat
         8   -> __aeabi_d2f
         8   -> __aeabi_dmul
         8   -> __aeabi_f2d
         8   -> __aeabi_fdiv
         8   -> __aeabi_fmul
         8   -> __aeabi_fsub
         8   -> tan
      16   Angle_Kalman
        16   -> L3G4200_Read
        16   -> __aeabi_d2f
        16   -> __aeabi_dadd
        16   -> __aeabi_ddiv
        16   -> __aeabi_dmul
        16   -> __aeabi_dsub
        16   -> __aeabi_f2d
        16   -> __aeabi_fadd
        16   -> __aeabi_fdiv
        16   -> __aeabi_fmul
        16   -> __aeabi_fsub
        16   -> __aeabi_i2f
        16   -> __aeabi_ui2f
        16   -> acos
        16   -> hw_ad_ave
        16 __aeabi_cfcmple
        16 __aeabi_cfrcmple


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable0
       4  ??DataTable0_1
       8  ??DataTable0_10
       4  ??DataTable0_11
       4  ??DataTable0_12
       4  ??DataTable0_13
       4  ??DataTable0_14
       4  ??DataTable0_15
       8  ??DataTable0_16
       8  ??DataTable0_17
       4  ??DataTable0_18
       4  ??DataTable0_2
       4  ??DataTable0_3
       4  ??DataTable0_4
       4  ??DataTable0_5
       4  ??DataTable0_6
       4  ??DataTable0_7
       8  ??DataTable0_8
       4  ??DataTable0_9
       4  ??DataTable1
       4  ??DataTable1_1
       4  ??DataTable1_10
       4  ??DataTable1_11
       4  ??DataTable1_12
       4  ??DataTable1_13
       4  ??DataTable1_14
       8  ??DataTable1_15
       8  ??DataTable1_16
       4  ??DataTable1_17
       4  ??DataTable1_18
       4  ??DataTable1_19
       4  ??DataTable1_2
       4  ??DataTable1_20
       4  ??DataTable1_21
       4  ??DataTable1_22
       4  ??DataTable1_23
       4  ??DataTable1_3
       4  ??DataTable1_4
       4  ??DataTable1_5
       4  ??DataTable1_6
       4  ??DataTable1_7
       4  ??DataTable1_8
       4  ??DataTable1_9
     170  Angle_Controler
     748  Angle_Kalman
       4  Angle_Out
       4  D_angle
       4  E
       4  E_angle
       4  K_0
       4  K_1
      16  P
       4  P_angle
      16  Pdot
       4  Q_angle
       4  Q_gyro
       4  R_angle
       4  acc_angle
       4  acc_angle_cos
       4  acc_ave
       4  acc_mid
       4  angle_E
       4  angle_error
       4  angle_mid
       4  car_angle
       4  car_angle_speed
       4  gyr_angle
       4  gyr_angle_speed
       4  gyr_offset_x
       4  gyro_error
       4  low_spd_agl
       4  t_0
       4  t_1

 
    88 bytes in section .bss
    48 bytes in section .data
 1 114 bytes in section .text
 
 1 114 bytes of CODE memory
   136 bytes of DATA memory

Errors: none
Warnings: 1
